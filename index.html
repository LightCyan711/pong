<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>PONG â€” AI / Player / íŒ€ì „(2v2)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<style>
  :root{
    --bg:#F2F5FA; --ink:#1E2742; --muted:#8A96AC; --line:#E6ECF5;
    --card:#FFFFFF; --blue:#4C6FFF; --teal:#2CC6B3; --coral:#FF7A59; --gold:#FFBA49;
    --shadow:0 20px 60px rgba(20,26,51,.14);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font-family:Inter,Pretendard,system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
    overflow:hidden}
  .wrap{height:100vh;display:grid;place-items:center;padding:18px}
  .card{height:calc(100vh - 36px);width:min(1100px,96vw);background:var(--card);border-radius:20px;box-shadow:var(--shadow);position:relative;padding:16px}
  .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .title{font-weight:900;letter-spacing:.28rem}
  .badge{display:inline-flex;gap:8px;align-items:center;background:#fff;border:1px solid var(--line);border-radius:12px;padding:6px 10px;font-size:12px;color:var(--muted)}
  .dot{width:10px;height:10px;border-radius:50%;background:#cbd5e7}
  .ok{background:#2BD06B}.warn{background:#FFB020}
  #gameBox{position:relative;height:calc(100% - 46px)}
  canvas{display:block;width:100%;height:100%;border-radius:16px;box-shadow:inset 0 0 0 1px var(--line)}
  .ctrl{position:absolute;left:16px;right:16px;bottom:12px;display:flex;gap:8px;align-items:center;z-index:4}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:var(--ink);color:#fff;font-weight:800;cursor:pointer}
  .btn.alt{background:var(--blue)} .btn.ghost{background:#fff;color:var(--ink);box-shadow:inset 0 0 0 1px var(--line)}
  .overlay{position:absolute;inset:0;border-radius:16px;background:
    radial-gradient(1200px 600px at 50% -40%, rgba(76,111,255,.10), transparent 60%), rgba(246,248,252,.92);
    backdrop-filter:blur(6px) saturate(1.2);display:none;z-index:5}
  .ctr{position:absolute;inset:0;display:grid;place-items:center;padding:16px}
  .modes{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;width:min(880px,92%)}
  .mode{border-radius:16px;padding:16px;background:linear-gradient(180deg,#fff,#f8faff);border:1px solid var(--line);cursor:pointer;text-align:center}
  .mode:hover{box-shadow:0 12px 26px rgba(76,111,255,.18);transform:translateY(-2px)}
  .small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="top">
      <div class="title">P O N G</div>
      <div class="badge"><span id="fps">0 fps</span><span class="dot" id="aiDot"></span><span id="aiTxt">AI: loadingâ€¦</span></div>
    </div>

    <div id="gameBox">
      <canvas id="cv" width="800" height="600"></canvas>

      <!-- Title -->
      <section id="titleOv" class="overlay" style="display:block;cursor:pointer">
        <div class="ctr">
          <div style="display:grid;gap:18px;place-items:center">
            <h1 style="margin:0;font-size:64px;letter-spacing:.7rem">P o n g</h1>
            <div class="small">í™”ë©´ì„ í´ë¦­í•˜ì—¬ í”Œë ˆì´</div>
          </div>
        </div>
      </section>

      <!-- Mode -->
      <section id="modeOv" class="overlay">
        <div class="ctr" style="gap:14px">
          <h2 style="margin:0 0 6px;font-size:34px">ëª¨ë“œ ì„ íƒ</h2>
          <div class="modes">
            <div class="mode" data-mode="aiai"><h3>AI vs AI</h3><div class="small">ì–‘ìª½ ëª¨ë‘ ONNX(ì‹¤íŒ¨ ì‹œ íœ´ë¦¬ìŠ¤í‹±)</div></div>
            <div class="mode" data-mode="aip"><h3>AI vs í”Œë ˆì´ì–´</h3><div class="small">ì˜¤ë¥¸ìª½: ë‹¹ì‹ (â†‘/â†“ ë˜ëŠ” W/S)</div></div>
            <div class="mode" data-mode="team"><h3>íŒ€ì „ 2v2(ë¡œì»¬)</h3><div class="small">ì¢Œ/ìš° ê°ê° 2ëª…, íŒ¨ë“¤ ìƒ‰ìƒìœ¼ë¡œ êµ¬ë¶„</div></div>
          </div>
          <div class="small">ì¼ì‹œì •ì§€ P</div>
        </div>
      </section>

      <!-- Finish -->
      <section id="postOv" class="overlay">
        <div class="ctr" id="postInner"></div>
      </section>

      <!-- Controls -->
      <div class="ctrl">
        <button id="btnTitle" class="btn ghost">íƒ€ì´í‹€</button>
        <button id="btnReset" class="btn">ì¬ì‹œì‘</button>
        <button id="btnPause" class="btn alt">ì¼ì‹œì •ì§€</button>
        <div style="margin-left:auto;font-weight:900"><span id="time">â€“:â€“â€“</span></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
<script>
/* ======= Constants ======= */
const W=800,H=600,PW=12,PH=88,BR=8, PAD_SPEED=420, B_INIT=340, B_MAX=720, GROW=1.025, ANG_MAX=(38*Math.PI)/180;
const MATCH_SEC=120, WIN_SCORE=11;
const COLORS={L1:'#4C6FFF', L2:'#2CC6B3', R1:'#FF7A59', R2:'#FFBA49'};

/* ======= Canvas/DOM ======= */
const cv=document.getElementById('cv'), ctx=cv.getContext('2d'); ctx.imageSmoothingEnabled=true;
const fpsEl=document.getElementById('fps'), aiDot=document.getElementById('aiDot'), aiTxt=document.getElementById('aiTxt');
const titleOv=document.getElementById('titleOv'), modeOv=document.getElementById('modeOv'), postOv=document.getElementById('postOv'), postInner=document.getElementById('postInner');
const timeEl=document.getElementById('time');

/* ======= Game State ======= */
const S={
  scene:'title', mode:null, paused:false, step:1/60, last:performance.now(), run:false,
  ball:{x:W/2,y:H/2,vx:B_INIT,vy:0},
  sL:0, sR:0, rallyRight:Math.random()<.5, t:MATCH_SEC,
  L:[], R:[],
  trail:[] // ğŸ”¥ ë¶ˆ ì´í™íŠ¸(ì”ìƒ) ê¸°ë¡
};

/* ======= Helpers ======= */
function show(el,on){ el.style.display=on?'block':'none'; }
function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
function rr(x,y,w,h,r,c){ const rr=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath(); ctx.fillStyle=c; ctx.fill(); }
function circle(x,y,r,c){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.closePath(); ctx.fillStyle=c; ctx.fill(); }
function bg(){ ctx.fillStyle='#F6F8FC'; ctx.fillRect(0,0,W,H); ctx.fillStyle='#DCE4EE'; for(let y=0;y<H;y+=24) ctx.fillRect(W/2-2,y,4,12); }
function fmt(t){ const m=Math.floor(t/60), s=Math.floor(t%60); return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

/* ======= Input ======= */
const Keys=new Map();
addEventListener('keydown',e=>{ Keys.set(e.code,true); if(e.code==='KeyP')S.paused=!S.paused; });
addEventListener('keyup',e=>{ Keys.set(e.code,false); });

/* ======= Title â†’ Mode ======= */
titleOv.addEventListener('click',()=>{ if(S.scene==='title'){ show(titleOv,false); show(modeOv,true); S.scene='mode'; }});
document.addEventListener('keydown',e=>{ if(e.key==='Enter'&&S.scene==='title'){ titleOv.click(); }});

/* ======= Mode buttons (ì¦‰ì‹œ ì‹œì‘) ======= */
document.querySelectorAll('.mode').forEach(m=>{
  m.onclick=()=>{ S.mode=m.dataset.mode; show(modeOv,false); show(postOv,false); startMode(S.mode); };
});

/* ======= Buttons ======= */
document.getElementById('btnTitle').onclick=()=>{ S.scene='title'; S.run=false; show(titleOv,true); show(modeOv,false); show(postOv,false); };
document.getElementById('btnReset').onclick=()=> resetMatch(true);
document.getElementById('btnPause').onclick=()=> S.paused=!S.paused;

/* ======= ONNX AI ======= */
let ortSession=null, aiReady=false;
(async()=>{
  try{
    aiTxt.textContent='AI: loadingâ€¦'; aiDot.className='dot';
    ortSession = await ort.InferenceSession.create('model.onnx',{executionProviders:['wasm']});
    aiReady=true; aiTxt.textContent='AI: loaded'; aiDot.className='dot ok';
  }catch(e){ aiReady=false; aiTxt.textContent='AI: failed (heuristic)'; aiDot.className='dot warn'; }
})();
function obsLeft(py,oy){
  const bx=(S.ball.x/W)*2-1, by=(S.ball.y/H)*2-1;
  const speed=Math.hypot(S.ball.vx,S.ball.vy);
  const bvx=clamp(S.ball.vx/B_MAX,-1,1), bvy=clamp(S.ball.vy/B_MAX,-1,1);
  const p=(py/H)*2-1, o=(oy/H)*2-1;
  const rp=clamp((S.ball.y-py)/(H/2),-1,1), ro=clamp((S.ball.y-oy)/(H/2),-1,1);
  return new ort.Tensor('float32', new Float32Array([bx,by,bvx,bvy,p,o,rp,ro]), [1,8]);
}
function obsRightMirror(py,oy){
  const bx=((W-S.ball.x)/W)*2-1, by=(S.ball.y/H)*2-1;
  const bvx=clamp(-S.ball.vx/B_MAX,-1,1), bvy=clamp(S.ball.vy/B_MAX,-1,1);
  const p=(py/H)*2-1, o=(oy/H)*2-1;
  const rp=clamp((S.ball.y-py)/(H/2),-1,1), ro=clamp((S.ball.y-oy)/(H/2),-1,1);
  return new ort.Tensor('float32', new Float32Array([bx,by,bvx,bvy,p,o,rp,ro]), [1,8]);
}
async function aiActLeft(py,oy){
  if(!aiReady||!ortSession){ return (S.ball.y<py-3)?0:(S.ball.y>py+3)?2:1; }
  try{ const out=await ortSession.run({observation:obsLeft(py,oy)}); const k=Object.keys(out)[0]; return ((out[k].data||out[k])[0]|0); }catch{ return (S.ball.y<py-3)?0:(S.ball.y>py+3)?2:1; }
}
async function aiActRight(py,oy){
  if(!aiReady||!ortSession){ return (S.ball.y<py-3)?0:(S.ball.y>py+3)?2:1; }
  try{ const out=await ortSession.run({observation:obsRightMirror(py,oy)}); const k=Object.keys(out)[0]; return ((out[k].data||out[k])[0]|0); }catch{ return (S.ball.y<py-3)?0:(S.ball.y>py+3)?2:1; }
}

/* ======= Paddles / Modes ======= */
function makePaddle(side,color,upKey,downKey,aiSide){
  return {y:H/2, color, upKey, downKey, aiSide};
}
function startMode(mode){
  S.sL=0; S.sR=0; S.t=MATCH_SEC; S.rallyRight=Math.random()<.5; S.paused=false; S.run=true; S.scene='play';
  S.trail.length=0;
  S.ball.x=W/2; S.ball.y=H/2; const a=(Math.random()*0.7-0.35), dir=S.rallyRight?1:-1;
  S.ball.vx=dir*B_INIT*Math.cos(a); S.ball.vy=B_INIT*Math.sin(a);

  S.L=[]; S.R=[];
  if(mode==='aiai'){
    S.L.push(makePaddle('L', COLORS.L1, null, null, 'L'));
    S.R.push(makePaddle('R', COLORS.R1, null, null, 'R'));
  }else if(mode==='aip'){
    S.L.push(makePaddle('L', COLORS.L1, null, null, 'L'));               // ì™¼ìª½ AI
    S.R.push(makePaddle('R', COLORS.R1, 'ArrowUp','ArrowDown', null));   // ì˜¤ë¥¸ìª½ Human
  }else if(mode==='team'){
    // ì¢Œì¸¡ 2ëª…, ìš°ì¸¡ 2ëª… (ê°ê¸° ë‹¤ë¥¸ í‚¤)
    S.L.push(makePaddle('L', COLORS.L1, 'KeyW','KeyS', null));  // L1: W/S
    S.L.push(makePaddle('L', COLORS.L2, 'KeyT','KeyG', null));  // L2: T/G
    S.R.push(makePaddle('R', COLORS.R1, 'ArrowUp','ArrowDown', null)); // R1: â†‘/â†“
    S.R.push(makePaddle('R', COLORS.R2, 'KeyI','KeyK', null));         // R2: I/K
  }
}

/* ======= Physics & Step ======= */
function apply(p, act){
  const d=(act===0?-1:(act===2?1:0))*PAD_SPEED*S.step;
  p.y=clamp(p.y+d, PH/2, H-PH/2);
}
function circleRect(cx,cy,cr,rx,ry,rw,rh){
  const nx=clamp(cx,rx,rx+rw), ny=clamp(cy,ry,ry+h);
  const dx=cx-nx, dy=cy-ny;
  return dx*dx+dy*dy<=cr*cr;
}
function bounce(isLeft, py){
  // ì†ë„ ì¦ê°€ + ê°ë„ ë³€í™”
  const off=clamp((S.ball.y-py)/(PH/2),-1,1);
  const sp=Math.min(B_MAX, Math.hypot(S.ball.vx,S.ball.vy)*GROW);
  const ang=off*ANG_MAX; const dir=isLeft?1:-1;
  S.ball.vx=dir*sp*Math.cos(ang); S.ball.vy=sp*Math.sin(ang);
  S.ball.x+=dir*(PW/2+BR+2); S.ball.y+=(Math.random()*4-2);
  // ì”ìƒ í­ë°œê°(ì¶©ëŒ ì‹œ ì¦‰ì‹œ ëª‡ ì  ì¶”ê°€)
  for(let i=0;i<6;i++){
    S.trail.unshift({x:S.ball.x - dir*i*4, y:S.ball.y + (Math.random()*6-3), heat:1, r:BR+(i%2)});
  }
}
function resetRound(){
  S.trail.length=0;
  S.L.forEach(p=>p.y=H/2); S.R.forEach(p=>p.y=H/2); S.ball.x=W/2; S.ball.y=H/2;
  const a=(Math.random()*0.7-0.35), dir=S.rallyRight?1:-1; S.ball.vx=dir*B_INIT*Math.cos(a); S.ball.vy=B_INIT*Math.sin(a);
}

/* ======= Fire/Trail Rendering ======= */
function drawFlameTrail(){
  const speed=Math.hypot(S.ball.vx,S.ball.vy);
  const heat=clamp((speed - B_INIT)/(B_MAX - B_INIT), 0, 1); // 0~1
  const trailLen = Math.floor(6 + heat*24);
  // ìµœì‹  ìœ„ì¹˜ push
  S.trail.unshift({x:S.ball.x, y:S.ball.y, heat, r:BR});
  if(S.trail.length > 80) S.trail.length = 80;

  // ë¶ˆë¹›(ê°€ì‚° í•©ì„±)
  ctx.save();
  ctx.globalCompositeOperation='lighter';

  // ì”ìƒ: ë’¤ë¡œ ê°ˆìˆ˜ë¡ íˆ¬ëª…/ì‘ì•„ì§
  for(let i=0;i<Math.min(trailLen, S.trail.length); i++){
    const t = i / trailLen;                 // 0(ì•)~1(ë’¤)
    const p = S.trail[i];
    const a = (1 - t) * (0.10 + 0.35*heat); // alpha
    const r = p.r * (1 + 0.6*(1 - t) * (0.2 + 0.8*heat));

    // ì™¸ê³½ ê¸€ë¡œìš°(ë¶‰ì€ìƒ‰â†’ë…¸ë€ìƒ‰)
    const grad = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, r*2);
    const c1 = `rgba(255,80,35,${a*0.6})`;
    const c2 = `rgba(255,180,60,${a*0.18})`;
    grad.addColorStop(0, c1);
    grad.addColorStop(1, c2);
    ctx.fillStyle=grad;
    ctx.beginPath(); ctx.arc(p.x, p.y, r*2, 0, Math.PI*2); ctx.fill();

    // ì½”ì–´(ë…¸ë€ìƒ‰)
    ctx.fillStyle = `rgba(255,200,70,${a})`;
    ctx.beginPath(); ctx.arc(p.x, p.y, Math.max(2, r*0.6), 0, Math.PI*2); ctx.fill();
  }

  // í˜„ì¬ ê³µ ì£¼ë³€ì˜ ê°•í•œ ê¸€ë¡œìš°
  {
    const a0 = 0.20 + 0.45*heat;
    const r0 = BR*(2.2 + 2.0*heat);
    const g0 = ctx.createRadialGradient(S.ball.x, S.ball.y, 0, S.ball.x, S.ball.y, r0);
    g0.addColorStop(0, `rgba(255,210,80,${a0})`);
    g0.addColorStop(1, `rgba(255,120,40,0)`);
    ctx.fillStyle = g0;
    ctx.beginPath(); ctx.arc(S.ball.x, S.ball.y, r0, 0, Math.PI*2); ctx.fill();
  }

  ctx.restore();
}

/* ======= Render ======= */
function draw(){
  bg();

  // ğŸ”¥ ë¨¼ì € íŠ¸ë ˆì¼(ë¶ˆ ì´í™íŠ¸)
  drawFlameTrail();

  // íŒ¨ë“¤
  for(const p of S.L){ rr(26, p.y-PH/2, PW, PH, 6, p.color); }
  for(const p of S.R){ rr(W-26-PW, p.y-PH/2, PW, PH, 6, p.color); }

  // ê³µ (ì½”ì–´/ì™¸ê³½)
  circle(S.ball.x,S.ball.y,BR,'#222');
  circle(S.ball.x,S.ball.y,BR-2,'#1e1e1e');
  circle(S.ball.x,S.ball.y,BR-3,'#FFC857');

  // ìŠ¤ì½”ì–´
  ctx.fillStyle='#1E2742'; ctx.font='bold 28px Inter,system-ui';
  ctx.textAlign='right'; ctx.fillText(String(S.sL), W*0.5-60,40);
  ctx.textAlign='left'; ctx.fillText(String(S.sR), W*0.5+60,40);
}

/* ======= Loop ======= */
let fpsA=0,fpsN=0;
function loop(now=performance.now()){
  const dt=Math.min(.05,(now-S.last)/1000); S.last=now; fpsA+=dt; fpsN++; if(fpsA>=.5){ fpsEl.textContent=Math.round(fpsN/fpsA)+' fps'; fpsA=0; fpsN=0; }
  if(S.scene==='play' && !S.paused){
    // inputs / AI
    for(const p of S.L){
      let act=1;
      if(p.upKey||p.downKey){
        const u=Keys.get(p.upKey), d=Keys.get(p.downKey);
        act = u&&!d?0 : d&&!u?2 : 1;
        if(!u && !d && S.mode==='team'){ act = (S.ball.y<p.y-6)?0:(S.ball.y>p.y+6)?2:1; }
      }else if(p.aiSide==='L'){ act = (S.ball.y<p.y-3)?0:(S.ball.y>p.y+3)?2:1; }
      apply(p, act);
    }
    for(const p of S.R){
      let act=1;
      if(p.upKey||p.downKey){
        const u=Keys.get(p.upKey), d=Keys.get(p.downKey);
        act = u&&!d?0 : d&&!u?2 : 1;
        if(!u && !d && S.mode==='team'){ act = (S.ball.y<p.y-6)?0:(S.ball.y>p.y+6)?2:1; }
      }else if(p.aiSide==='R'){ act = (S.ball.y<p.y-3)?0:(S.ball.y>p.y+3)?2:1; }
      apply(p, act);
    }

    // move ball
    S.ball.x+=S.ball.vx*dt; S.ball.y+=S.ball.vy*dt;
    if(S.ball.y<=BR){ S.ball.y=BR; S.ball.vy=Math.abs(S.ball.vy); }
    if(S.ball.y>=H-BR){ S.ball.y=H-BR; S.ball.vy=-Math.abs(S.ball.vy); }

    // collisions with paddles
    if(S.ball.vx<0){
      for(const p of S.L){
        const L={x:26,y:p.y-PH/2,w:PW,h:PH};
        if(circleRect(S.ball.x,S.ball.y,BR, L.x,L.y,L.w,L.h)){ bounce(true, p.y); break; }
      }
    }else{
      for(const p of S.R){
        const R={x:W-26-PW,y:p.y-PH/2,w:PW,h:PH};
        if(circleRect(S.ball.x,S.ball.y,BR, R.x,R.y,R.w,R.h)){ bounce(false, p.y); break; }
      }
    }

    // goals
    if(S.ball.x<-BR){ S.sR++; S.rallyRight=true; resetRound(); }
    if(S.ball.x>W+BR){ S.sL++; S.rallyRight=false; resetRound(); }

    // timer
    if(S.run){ S.t=Math.max(0,S.t-dt); timeEl.textContent=fmt(S.t); if(S.t===0){ endMatch(); } }
  }
  draw(); requestAnimationFrame(loop);
}
requestAnimationFrame(loop); bg();

/* ======= Round/Modes ======= */
function resetMatch(full){
  S.sL=0; S.sR=0; S.t=MATCH_SEC; S.rallyRight=Math.random()<.5; S.paused=false;
  S.trail.length=0;
  S.ball.x=W/2; S.ball.y=H/2; const a=(Math.random()*0.7-0.35), dir=S.rallyRight?1:-1; S.ball.vx=dir*B_INIT*Math.cos(a); S.ball.vy=B_INIT*Math.sin(a);
  S.L.forEach(p=>p.y=H/2); S.R.forEach(p=>p.y=H/2);
}
function endMatch(){
  S.run=false; show(postOv,true);
  postInner.innerHTML=`<div style="display:grid;gap:12px;place-items:center">
    <div style="font-size:40px;font-weight:900">ê²½ê¸° ì¢…ë£Œ</div>
    <div style="font-weight:900">${S.sL} : ${S.sR}</div>
    <button class="btn alt" onclick="show(postOv,false); show(modeOv,true);">ëª¨ë“œë¡œ ëŒì•„ê°€ê¸°</button>
  </div>`;
}
</script>
</body>
</html>
